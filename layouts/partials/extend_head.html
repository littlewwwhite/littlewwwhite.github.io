{{- /* Head custom content area start */ -}}
{{- /*     Insert any custom code (web-analytics, resources, etc.) - it will appear in the <head></head> section of every page. */ -}}
{{- /*     Can be overwritten by partial with the same name in the global layouts. */ -}}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel="stylesheet">

{{- /* KaTeX 支持 */ -}}
{{ if or .Params.math .Site.Params.math.enable }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTWjIxAprGRv5/1DhXb8PKjp+4YYsuv4x/SQOqnJwN0h+KNWDqy8" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // 预处理：修复可能的 Markdown 解析问题
        document.querySelectorAll('.post-content').forEach(function(element) {
            let content = element.innerHTML;
            
            // 修复块级公式，将 $$ 替换为临时标记
            content = content.replace(/\$\$([\s\S]*?)\$\$/g, function(match, formula) {
                // 使用特殊标记替换 $$，避免被后续处理影响
                return '<div class="math math-display">@@DISPLAY_MATH_START@@' + formula + '@@DISPLAY_MATH_END@@</div>';
            });
            
            // 修复行内公式
            content = content.replace(/\$((?!\$).*?)\$/g, function(match, formula) {
                return '<span class="math math-inline">' + match + '</span>';
            });
            
            // 还原块级公式的标记
            content = content.replace(/@@DISPLAY_MATH_START@@([\s\S]*?)@@DISPLAY_MATH_END@@/g, function(match, formula) {
                return formula;
            });
            
            element.innerHTML = content;
        });

        // 配置 KaTeX 渲染
        renderMathInElement(document.body, {
            delimiters: [
                {left: '<div class="math math-display">', right: '</div>', display: true},
                {left: '$', right: '$', display: false}
            ],
            ignoredTags: [
                'script', 'noscript', 'style', 'textarea', 'pre', 'code',
                'option', 'template'
            ],
            throwOnError: false,
            errorColor: '#FF5555',
            strict: false,
            trust: true,
            macros: {
                "\\underscore": "_"
            }
        });
    });
</script>

<style>
    .math.math-display {
        display: block;
        margin: 1em 0;
        text-align: center;
    }
    .math.math-inline {
        display: inline-block;
        padding: 0 0.2em;
    }
    .katex-display {
        margin: 1em 0 !important;
        overflow-x: auto;
        overflow-y: hidden;
    }
    .katex {
        font-size: 1em !important;
    }
</style>
{{ end }}

{{- /* Mermaid 支持 */ -}}
{{ if .Page.Store.Get "hasMermaid" }}
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
    const initializeMermaid = () => {
        const isDark = document.body.className.includes('dark');
        const theme = isDark ? 
            '{{ .Site.Params.mermaid.theme.dark | default "dark" }}' : 
            '{{ .Site.Params.mermaid.theme.light | default "default" }}';
        
        mermaid.initialize({
            startOnLoad: true,
            theme: theme,
            align: '{{ .Site.Params.mermaid.align | default "center" }}',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                useMaxWidth: true,
                showSequenceNumbers: true
            }
        });
    };

    // 初始化
    document.addEventListener('DOMContentLoaded', initializeMermaid);

    // 监听主题切换
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.attributeName === 'class') {
                mermaid.initialize({ theme: document.body.className.includes('dark') ? 
                    '{{ .Site.Params.mermaid.theme.dark | default "dark" }}' : 
                    '{{ .Site.Params.mermaid.theme.light | default "default" }}'
                });
                // 重新渲染所有图表
                mermaid.init(undefined, document.querySelectorAll('.mermaid'));
            }
        });
    });

    observer.observe(document.body, {
        attributes: true
    });
</script>
{{ end }}
{{- /* Head custom content area end */ -}}
