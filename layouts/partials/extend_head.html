{{- /* Head custom content area start */ -}}
{{- /*     Insert any custom code (web-analytics, resources, etc.) - it will appear in the <head></head> section of every page. */ -}}
{{- /*     Can be overwritten by partial with the same name in the global layouts. */ -}}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel="stylesheet">

{{- /* MathJax 支持 */ -}}
{{ if or .Params.math .Site.Params.math.enable }}
<script>
    MathJax = {
        tex: {
            inlineMath: [['$', '$']],
            displayMath: [['$$', '$$']],
            processEscapes: true,
            processEnvironments: true,
            tags: 'ams'
        },
        options: {
            skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
        },
        startup: {
            pageReady: () => {
                return MathJax.startup.defaultPageReady().then(() => {
                    // 处理暗色主题
                    if (document.body.classList.contains('dark')) {
                        document.querySelectorAll('.MathJax').forEach(math => {
                            math.style.color = 'var(--content)';
                        });
                    }
                });
            }
        }
    };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>
    .math.math-display {
        overflow-x: auto;
        overflow-y: hidden;
        margin: 1em 0;
    }
    .MathJax {
        outline: none;
    }
    /* 暗色主题适配 */
    .dark .MathJax {
        color: var(--content);
    }
</style>

<!-- 添加主题切换监听 -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'class') {
                    const isDark = document.body.classList.contains('dark');
                    document.querySelectorAll('.MathJax').forEach(math => {
                        math.style.color = isDark ? 'var(--content)' : 'inherit';
                    });
                }
            });
        });

        observer.observe(document.body, {
            attributes: true
        });
    });
</script>
{{ end }}

{{- /* Mermaid 支持 */ -}}
{{ if .Page.Store.Get "hasMermaid" }}
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
<script>
  // 初始化 mermaid 配置
  document.addEventListener('DOMContentLoaded', function() {
    const isDark = document.documentElement.classList.contains('dark');
    const theme = isDark ? 'dark' : 'default';
    
    mermaid.initialize({
      startOnLoad: true,
      theme: theme,
      flowchart: {
        useMaxWidth: true,
        htmlLabels: true,
        curve: 'basis',
      },
      themeVariables: {
        fontFamily: 'var(--font-family)',
        fontSize: '16px',
      },
      securityLevel: 'loose',
    });

    // 监听主题切换
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.attributeName === 'class') {
          const isDarkNow = document.documentElement.classList.contains('dark');
          const newTheme = isDarkNow ? 'dark' : 'default';
          
          // 重新渲染所有图表
          document.querySelectorAll('.mermaid').forEach(function(element) {
            const graphCode = element.textContent.trim();
            if (graphCode) {
              try {
                // 清空当前图表
                element.innerHTML = graphCode;
                // 使用新主题重新渲染
                mermaid.initialize({ theme: newTheme });
                mermaid.init(undefined, element);
              } catch (error) {
                console.error('Mermaid 重新渲染失败:', error);
              }
            }
          });
        }
      });
    });

    observer.observe(document.documentElement, {
      attributes: true
    });
  });
</script>
{{ end }}
{{- /* Head custom content area end */ -}}
